<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <script type="importmap">
        {
          "imports": {
            "three": "https://unpkg.com/three@0.162.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.162.0/examples/jsm/"
          }
        }
    </script>
    <script type="module" src="./js/GLTFCanvas.js"></script>
    <script type="module">
        import { GLTFCanvas } from './js/GLTFCanvas.js';
        import { ImageService } from './js/ImageService.js'



        const cameraPosition = { 
            x: 0, y: 0.07, z: 0.12 
        };
        const modelPosition = { 
            x: 0, y: 0, z: 0 
        };

        const canvas = new GLTFCanvas(cameraPosition, './assets/background.jpg', 1280, 720);
        document.body.appendChild(canvas.getRendererDom());

        const imgService = new ImageService();

        const host = 'localhost'
        const port = 6004
        const connection = new WebSocket(`ws://${host}:${port}/`)
        connection.onmessage = async (e) => {
            const json = JSON.parse(e.data.toString())

            let urlData = URL.createObjectURL(new Blob([json.File]))
            canvas.loadModel(modelPosition, urlData);
            
            while(!canvas.isCompleted) {
                await new Promise(r => setTimeout(r, 1000));
            }

            let img = imgService.get(document.getElementsByTagName('canvas')[0])
            const body = {
                FilePath: json.FilePath,
                File: img
            }
            connection.send(JSON.stringify(body))
        }
    </script>
</head>
<body>
</body>
</html>